<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aura Affinity ‚Ä¢ Business Directory & Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#0e0e10; --panel:#141418; --text:#e6e6ea; --muted:#9aa0a6; --gold:#f7c948; }
    * { box-sizing: border-box }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text);}    
    header { padding:18px 20px 8px; text-align:center; background:#0b0b0d; border-bottom:1px solid #1e1f25; position:sticky; top:0; z-index:5 }
    h1{ margin:0; color:var(--gold); letter-spacing:.5px }
    .sub{ margin:6px 0 12px; color:var(--muted); font-size:.95rem }
    .container { max-width: 1200px; margin: 0 auto; }
    #map { height:60vh; width:100%; border-bottom:1px solid #1e1f25; position:relative }
    .toolbar { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; padding:12px 16px; background:#0b0b0d; border-bottom:1px solid #1e1f25 }
    .toolbar .field { display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid #23242b; padding:8px 12px; border-radius:12px }
    .toolbar label { color:#c7c9ce; font-size:.9rem }
    .toolbar input[type="text"], .toolbar select { background:transparent; border:none; color:var(--text); outline:none; font-size:.95rem; appearance:none }
    .toolbar select { padding-right:20px; }
    .toolbar option { background:var(--panel); color:var(--text); }
    .toolbar input::placeholder { color:#7a7f87 }
    #directory { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:16px; padding:16px }
    .card { background:var(--panel); border:1px solid #262832; padding:14px; border-radius:16px; transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease; position:relative; display: flex; flex-direction: column; }
    .card:hover { transform: translateY(-2px) }
    .card .name { font-weight:700; font-size:1.05rem; margin:0 0 6px }
    .meta { display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:#c7c9ce; font-size:.9rem; margin-bottom:12px }
    .badge { padding:3px 8px; border-radius:999px; font-size:.75rem; border:1px solid rgba(255,255,255,.15) }
    .actions { margin-top: auto; display:flex; gap: 15px; align-items:center; flex-wrap:wrap; font-size: 0.9rem; }
    .actions a { color:#7dcfff; text-decoration:none; display:inline-flex; align-items:center; gap: 4px; }
    .actions a:hover { text-decoration:underline }
    .delete { position:absolute; top:10px; right:10px; background:#ef4444; color:#fff; border:none; border-radius:10px; padding:4px 8px; cursor:pointer; font-size:.75rem }
    .delete:hover { filter:brightness(1.1) }
    .card { box-shadow: 0 0 0px rgba(0,0,0,0); border-color:#262832 }
    .card[style*="--glow:"] { box-shadow: 0 0 14px var(--glow); border-color: var(--glow) }
    .sticky-actions { position: fixed; right: 16px; bottom: 16px; display:flex; flex-direction:column; gap:10px; z-index: 2000; }
    .fab { width:48px; height:48px; border-radius:50%; border:none; color:white; font-size:22px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 16px rgba(0,0,0,0.35); transition:transform .2s, box-shadow .2s }
    .fab:hover { transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,0.45) }
    .fab.blue { background:#3b82f6 }
    .map-fab { position:absolute; right:15px; bottom:15px; z-index:1000; background:#22c55e }
    .adder { background:#0b0b0d; border-top:1px solid #1e1f25; padding:14px 16px }
    .adder .row { display:flex; flex-wrap:wrap; gap:10px; justify-content:center }
    .adder input, .adder select { background:var(--panel); border:1px solid #23242b; color:var(--text); padding:8px 10px; border-radius:10px }
    .adder button { background:#3b82f6; color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer }
    .adder button.secondary { background:#475569 }
  </style>
</head>
<body>
  <header>
    <h1>Aura Affinity Map</h1>
    <div class="sub">A living directory of businesses carrying the name ‚ÄúAura‚Äù across the world. Verify, connect, and grow the network.</div>
    <div id="status-bar" style="font-size: 0.85rem; color: #9aa0a6; margin-top: 10px;">
      <span>Last updated: <strong id="last-updated">loading...</strong></span>
      <a id="trigger-run" href="https://github.com/auraofintelligence/aura-affinity/actions/workflows/update-map-data.yml" target="_blank" style="margin-left: 15px; color: #3b82f6; text-decoration: none;">
        üöÄ Trigger New Run
      </a>
    </div>
  </header>

  <div id="map" role="region" aria-label="Aura Affinity map">
    <button class="fab map-fab" id="recenter" title="Re-center map">üéØ</button>
  </div>

  <div class="toolbar">
    <div class="container" id="controls" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px; align-items:center;">
      <div class="field"><label for="q">Search</label><input id="q" type="text" placeholder="Search by name or website‚Ä¶" /></div>
      <div class="field"><label for="cat">Category</label>
        <select id="cat"><option value="">All</option></select>
      </div>
      <div class="field"><label for="country">Country</label>
        <select id="country"><option value="">All</option></select>
      </div>
      <div class="field"><label for="verified">Verified</label>
        <select id="verified">
          <option value="">All</option>
          <option value="true">Verified</option>
          <option value="false">Unverified</option>
        </select>
      </div>
      <div class="field"><label for="sort">Sort</label>
        <select id="sort">
          <option value="name-asc">Name A‚ÜíZ</option>
          <option value="name-desc">Name Z‚ÜíA</option>
          <option value="category">Category A‚ÜíZ</option>
          <option value="country">Country A‚ÜíZ</option>
          <option value="verified">Verified first</option>
        </select>
      </div>
      <div class="counter" style="color: #9aa0a6; font-size: 0.9rem; margin-left: 10px;">
        Showing <strong id="tile-counter" style="color: #e6e6ea;">0</strong> results
      </div>
    </div>
  </div>

  <div class="container"><div id="directory" aria-live="polite"></div></div>

  <div class="adder">
    <div class="container">
      <div class="row" aria-label="Add new entry">
        <input id="new-name" placeholder="Name" />
        <input id="new-category" placeholder="Category" />
        <input id="new-city" placeholder="City" />
        <input id="new-country" placeholder="Country" />
        <input id="new-lat" placeholder="Latitude" />
        <input id="new-lon" placeholder="Longitude" />
        <input id="new-website" placeholder="Website (https://...)" />
        <input id="new-email" placeholder="Email" />
        <input id="new-phone" placeholder="Phone" />
        <input id="new-social" placeholder="Social URL" />
        <select id="new-verified">
          <option value="false">Unverified</option>
          <option value="true">Verified</option>
        </select>
        <button id="add">Ôºã Add to list</button>
        <button id="download" class="secondary">‚¨áÔ∏è Download CSV</button>
      </div>
    </div>
  </div>

  <div class="sticky-actions" aria-label="Page navigation helpers">
    <button class="fab blue" id="toTop" title="Scroll to top">‚¨Ü</button>
    <button class="fab blue" id="toBottom" title="Scroll to bottom">‚¨á</button>
  </div>

  <script>
    const markerColorName = {
      'Health & Wellbeing': 'red',
      'Creative Industries': 'orange',
      'Event Management': 'gold',
      'Accommodation': 'blue',
      'Cities & Developments': 'green',
      'Blockchain': 'violet',
      '': 'blue',
    };
    const ICON_BASE = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/';
    function buildIcon(colorName){
      const c = ['red','orange','gold','green','blue','violet'].includes(colorName)? colorName : 'blue';
      return new L.Icon({
        iconUrl: ICON_BASE + `marker-icon-2x-${c}.png`,
        shadowUrl: ICON_BASE + 'marker-shadow.png',
        iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
      });
    }

    const map = L.map('map').setView([15, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap contributors' }).addTo(map);

    const clusterGroup = L.markerClusterGroup();
    map.addLayer(clusterGroup);

    let raw = [];
    let markers = [];
    function clearMarkers(){ clusterGroup.clearLayers(); markers = []; }

    function addMarker(entry){
      const color = markerColorName[entry.category] || 'blue';
      const icon = buildIcon(color);
      const m = L.marker([+entry.latitude, +entry.longitude], { icon });
      const safeUrl = (entry.website||'').startsWith('http') ? entry.website : (entry.website?`https://${entry.website}`:'');
      const location = [entry.city, entry.country].filter(Boolean).join(', ');
      const safeSocial = (entry.social||'').startsWith('http') ? entry.social : (entry.social?`https://${entry.social}`:'');
      m.bindPopup(`
        <strong>${entry.name}</strong><br>
        <small>${entry.category || '‚Äî'}</small><br>
        <em>${location || ''}</em>
        ${safeUrl ? `<br><a href="${safeUrl}" target="_blank">üåê Website</a>` : ''}
        ${entry.phone ? `<br>üìû ${entry.phone}` : ''}
        ${safeSocial ? `<br><a href="${safeSocial}" target="_blank">üîó Social</a>` : ''}
      `);
      m.__row = entry;
      clusterGroup.addLayer(m);
      markers.push(m);
      return m;
    }

    function setOptions(id, values){
      const sel = document.getElementById(id);
      const chosen = sel.value;
      sel.innerHTML = '<option value="">All</option>' + [...values].sort().map(v=>`<option value="${v}">${v}</option>`).join('');
      if(values.has(chosen)) sel.value = chosen;
    }

    function neonFromCategory(cat){
      const mapCol = { red:'#ef4444', orange:'#fb923c', gold:'#fbbf24', green:'#22c55e', blue:'#3b82f6', violet:'#a78bfa' };
      return mapCol[markerColorName[cat]||'blue']||'#3b82f6';
    }

    function renderDirectory(rows){
      const wrap = document.getElementById('directory');
      wrap.innerHTML = rows.map((r,i)=>{
        const glow = neonFromCategory(r.category);
        const safeUrl = (r.website||'').startsWith('http') ? r.website : (r.website?`https://${r.website}`:'');
        const safeSocial = (r.social||'').startsWith('http') ? r.social : (r.social?`https://${r.social}`:'');
        const verified = String(r.verified||'').toLowerCase()==='true';
        const location = [r.city, r.country].filter(Boolean).join(', ');

        return `<article class="card" style="--glow:${glow}">
            <button class="delete" data-id="${r.id||''}" title="Delete entry">Delete</button>
            <h3 class="name">${r.name || '‚Äî'}</h3>
            <div class="meta">
              <span class="badge" style="border-color:${glow}; color:${glow}">${r.category || 'Other'}</span>
              <span class="location-link" style="cursor: pointer;" title="Zoom to city">${location || ''}</span>
              <span class="badge" style="color:${verified?'#22c55e':'#eab308'}">${verified?'Verified':'Unverified'}</span>
            </div>
            ${r.description ? `<p style="font-size:0.85rem; color:#c7c9ce; margin:10px 0 0; opacity:0.8;">${r.description.substring(0, 100)}${r.description.length > 100 ? '...' : ''}</p>` : ''}
            <div class="actions">
              <a href="#" class="map-link" title="Find on map">üìç Map</a>
              ${safeUrl?`<a href="${safeUrl}" target="_blank" title="Website">üåê Website</a>`:''}
              ${r.phone?`<a href="tel:${r.phone}" title="Phone">üìû Phone</a>`:''}
              ${safeSocial?`<a href="${safeSocial}" target="_blank" title="Social Media">üîó Social</a>`:''}
            </div>
          </article>`
      }).join('');

      const cards = wrap.querySelectorAll('.card');
      cards.forEach((card, idx) => {
        const rowData = rows[idx];
        const marker = markers.find(m => m.__row === rowData);
        if (!marker) return;

        const mapLink = card.querySelector('.map-link');
        if (mapLink) {
          mapLink.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            map.flyTo(marker.getLatLng(), 16, { duration: 0.8 });
            marker.openPopup();
            document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
          });
        }
        
        const locationLink = card.querySelector('.location-link');
        if (locationLink) {
          locationLink.addEventListener('click', (e) => {
            e.stopPropagation();
            map.flyTo(marker.getLatLng(), 10, { duration: 0.8 });
          });
        }
      });
      
      wrap.querySelectorAll('.delete').forEach((btn, idx)=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const r = rows[idx];
          if(confirm(`Delete ‚Äú${r.name}‚Äù?`)){
            raw = raw.filter(x=>x!==r);
            refreshFilters();
            applyFilters();
          }
        });
      });
    }

    function sortRows(rows){
      const mode = document.getElementById('sort').value;
      const by = (key) => rows.sort((a,b)=> String(a[key]||'').localeCompare(String(b[key]||'')) );
      switch(mode){
        case 'name-desc': return by('name').reverse();
        case 'category': return by('category');
        case 'country': return by('country');
        case 'verified': return rows.sort((a,b)=> (String(b.verified).toLowerCase()==='true') - (String(a.verified).toLowerCase()==='true') || String(a.name||'').localeCompare(String(b.name||'')) );
        case 'name-asc':
        default: return by('name');
      }
    }

    function applyFilters(){
      const q = document.getElementById('q').value.trim().toLowerCase();
      const cat = document.getElementById('cat').value;
      const country = document.getElementById('country').value;
      const verified = document.getElementById('verified').value;

      let rows = raw.filter(r=>{
        if(!r.latitude || !r.longitude) return false;
        if(cat && r.category!==cat) return false;
        if(country && r.country!==country) return false;
        if(verified && String(r.verified).toLowerCase()!==verified) return false;
        if(q && !( (r.name||'').toLowerCase().includes(q) || (r.website||'').toLowerCase().includes(q) )) return false;
        return true;
      });

      document.getElementById('tile-counter').textContent = rows.length;

      rows = sortRows(rows);
      clearMarkers();
      rows.forEach(addMarker);
      renderDirectory(rows);
    }

    function refreshFilters(){
      setOptions('cat', new Set(raw.map(r=>r.category).filter(Boolean)));
      setOptions('country', new Set(raw.map(r=>r.country).filter(Boolean)));
    }

    fetch('aura-affinity.csv')
      .then(r=>r.text())
      .then(text=>{
        raw = Papa.parse(text, { header:true, skipEmptyLines:true }).data;
        raw = raw.map(d=>({ ...d, id: d.id || String(Date.now()+Math.random()), latitude: parseFloat(d.latitude), longitude: parseFloat(d.longitude) }));
        refreshFilters();
        applyFilters();
      });

    document.getElementById('q').addEventListener('input', applyFilters);
    document.getElementById('cat').addEventListener('change', applyFilters);
    document.getElementById('country').addEventListener('change', applyFilters);
    document.getElementById('verified').addEventListener('change', applyFilters);
    document.getElementById('sort').addEventListener('change', applyFilters);

    document.getElementById('toTop').addEventListener('click', ()=> window.scrollTo({ top:0, behavior:'smooth' }));
    document.getElementById('toBottom').addEventListener('click', ()=> window.scrollTo({ top:document.body.scrollHeight, behavior:'smooth' }));
    document.getElementById('recenter').addEventListener('click', ()=> map.setView([15, 0], 2));

    document.getElementById('add').addEventListener('click', ()=>{
      const n = id => document.getElementById(id).value.trim();
      const entry = {
        id: String(Date.now()),
        name: n('new-name'), category: n('new-category'), city: n('new-city'), country: n('new-country'),
        latitude: parseFloat(n('new-lat')), longitude: parseFloat(n('new-lon')),
        website: n('new-website'), email: n('new-email'), phone: n('new-phone'), social: n('new-social'),
        verified: n('new-verified')
      };
      if(!entry.name || isNaN(entry.latitude) || isNaN(entry.longitude)) { alert('Name, latitude and longitude are required.'); return; }
      raw.push(entry);
      refreshFilters();
      applyFilters();
      ['new-name','new-category','new-city','new-country','new-lat','new-lon','new-website','new-email','new-phone','new-social'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('new-verified').value='false';
    });

    document.getElementById('download').addEventListener('click', ()=>{
      const headers = ['place_id','id','name','category','city','country','latitude','longitude','website','email','phone','social','description','verified'];
      const toCsvRow = (row) => headers.map(h => {
        const val = row[h];
        const str = (val !== undefined && val !== null) ? String(val) : '';
        return `"${str.replaceAll('"', '""')}"`;
      }).join(',');
      const csvContent = [headers.join(',')].concat(raw.map(toCsvRow)).join('\n');
      const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'aura-affinity.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>

  <script>
    async function displayLastUpdated() {
      try {
        const response = await fetch(`last-run.txt?v=${Date.now()}`);
        if (!response.ok) throw new Error('Not found');
        const lastRunISO = await response.text();
        const lastRunDate = new Date(lastRunISO);
        const now = new Date();
        const diffMillis = now - lastRunDate;
        const diffHours = Math.floor(diffMillis / (1000 * 60 * 60));
        const diffDays = Math.floor(diffHours / 24);
        const remainingHours = diffHours % 24;
        const friendlyTime = `${diffDays} days, ${remainingHours} hours ago`;
        document.getElementById('last-updated').textContent = friendlyTime;
      } catch (error) {
        document.getElementById('last-updated').textContent = 'never';
      }
    }
    displayLastUpdated();
  </script>
</body>
</html>
